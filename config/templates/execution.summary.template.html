<HTML>
    <HEAD>
        <!-- jquery-->
        <SCRIPT src="https://code.jquery.com/jquery-3.1.0.min.js" integrity="sha256-cCueBR6CsyA4/9szpPfrX3s49M9vUU5BgtiJj06wt/s=" crossorigin="anonymous"></SCRIPT>
        <!--highcharts-->
        <SCRIPT src="http://code.highcharts.com/highcharts.js"></SCRIPT>
        <SCRIPT src="https://code.highcharts.com/modules/exporting.js"></SCRIPT>
        <!--bootstrap-->
        <SCRIPT src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></SCRIPT>
        <LINK rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
        <!--data tables-->
        <LINK rel="stylesheet" href="https://cdn.datatables.net/1.10.15/css/jquery.dataTables.min.css">
        <SCRIPT src="https://cdn.datatables.net/1.10.15/js/jquery.dataTables.min.js"></SCRIPT>

        <TITLE>Scipion execution summary for %(projectName)s </TITLE>
        %(refresh)s
    </HEAD>
    <STYLE>
        /* Color scheme based on http://paletton.com/#uid=300150kpYmAh8uxlUqhtHisBJda */
        BODY {
          text-align: center;
          margin: 0px;
        }

        #content {
          text-align: left;
          width: 800px;
          margin: 0 auto;
        }        
        H1 {
            border-bottom: 2px solid firebrick;
            color: #6E6E6E;
        }
        
        H2 {
/*            background: grey;*/
            color: firebrick;
            border-bottom: 1px solid firebrick;
            padding-left: 8px
        }

        SECTION {
        }
        LABEL {
            font-weight: bold;
            margin: 0px;
        }
        .propertyline {
            margin-top: 3px;
            margin-bottom: 4px;
            margin-left: 8px;
        }
        FOOTER {
            text-align: center;
            font-style: italic;
            font-size: small;
            margin: 20px 0px;
                
        }
        .icon {
            margin-left: 6px;
            height: 16px;
            width: 16px;
        }
        
        .icon,
        .valign {
            vertical-align: middle;
        }
        TABLE {
            border-collapse: collapse;
            margin: auto;
            width: 100%%;
        }
        TH {
            background: #EAEBEC;
            padding: 3px;
        }
        TD {
            padding: 5px;
        }
        .protocolLine {
            background: #F2F2F2;
        }
        .center {
            text-align: center;
        }
        a:focus, a:hover {
            color: firebrick;
        }
        .pager .active a{
            background-color : firebrick;
            color: #FFF;
            border: 0px;
        }

        .pagination>.active>a, .pagination>.active>a:focus, .pagination>.active>a:hover, .pagination>.active>span, .pagination>.active>span:focus, .pagination>.active>span:hover {
            background-color: firebrick;
            border-color: firebrick;
        }

        .pagination>li>a:hover, .pagination>li>span {
            color: firebrick;
        }

        .pagination>li>a, .pagination>li>span {
            color: firebrick;

        }

        .pager .active a:hover{
            color: firebrick;
            border: 0px;
        }

        .pager li>a, .pager li>span {
            color: firebrick;
        }

        .pager .next>a, .pager .next>span {
            float: none;
        }

        .pager .previous>a, .pager .previous>span {
            float: none;
        }

        .gallery-item{
            margin-bottom: 30px;

        }
        .modal-footer{
            text-align: center;

        }
        .pagination{
            margin: 0;
        }

        /* Grid layout classes */
        /* Taken from https://www.sitepoint.com/understanding-css-grid-systems/ */
        .row, 
        .column {
            box-sizing: border-box;
        }
        
        .row:before,
        .row:after {
            content: " ";
            display: table;
        }

        .row:after {
            clear: both;
        }
        
        .column {
            position: relative;
            float: left;
        }
        .column + .column {
            margin-left: 1.6%%;
        }
        .column-1 {
            width: 6.86666666667%%;
        }

        .column-2 {
            width: 15.3333333333%%;
        }

        .column-3 {
            width: 23.8%%;
        }

        .column-4 {
            width: 32.2666666667%%;
        }

        .column-5 {
            width: 40.7333333333%%;
        }

        .column-6 {
            width: 49.2%%;
        }

        .column-7 {
            width: 57.6666666667%%;
        }

        .column-8 {
            width: 66.1333333333%%;
        }

        .column-9 {
            width: 74.6%%;
        }

        .column-10 {
            width: 83.0666666667%%;
        }

        .column-11 {
            width: 91.5333333333%%;
        }

        .column-12 {
            width: 100%%;
        }
        @media only screen and (max-width: 550px) {
            .column-1, 
            .column-2, 
            .column-3, 
            .column-4, 
            .column-5, 
            .column-6, 
            .column-7, 
            .column-8, 
            .column-9, 
            .column-10, 
            .column-11, 
            .column-12 {
                width: auto;
                float: none;
            }

            .column + .column {
                margin-left: 0;
            }
        }
    </STYLE>
        <BODY>
        <DIV id="content" class="clearfix">
            <H1><img class="valign" src="https://cdn.rawgit.com/I2PC/scipion/master/pyworkflow/resources/scipion_logo_small.png">&nbsp;&nbsp; Project %(projectName)s </H1>
            <DIV class="row">
                <DIV class="column column-5">
                    <H2>Project properties</H2>
                    <P class="propertyline"><label>Start time:</label> <span>%(startTime)s</span></P>
                    <P class="propertyline"><label>Last update:</label> <span>%(dateStr)s</span></P>
                    <P class="propertyline"><label>Duration:</label> <span>%(projectDuration)s</span></P>
                    <P class="propertyline"><label>Status:</label> <span>%(projectStatus)s</span></P>
                    <P class="propertyline"><label>Scipion version:</label> <span>%(scipionVersion)s</span></P>

                    <DIV id="acquisition">
                        <H2>Acquisition</H2>
                    </DIV>
                </DIV>

                <DIV id="runs" class="column column-7">
                    <H2>Runs summary</H2>
                    <TABLE id="runsTable" class='center'>
                        <TR>
                            <TH>Name</TH>
                            <TH>Output</TH>
                            <TH>Number</TH>
                        </TR>
                    </TABLE>
                </DIV>
            </DIV>

            <SECTION id="ctf">
                <H2>CTF monitor</H2>
                <DIV id="ctfChart"></DIV>
            </SECTION>
            <SECTION id="system">
                <H2>System monitor</H2>
                <DIV id="systemChart"></DIV>
            </SECTION>
            <SECTION id="mics">
                <H2>Micrographs</H2>
                <!--<TABLE id="micTable" class="display"></TABLE>-->
                <DIV id="micThumbs" class="gallery">
                    <div class="row" id="gallery-pagination">
                        <nav aria-label="...">
                            <ul class="pager" role="tablist">
                                <li class="previous" onclick="goTo(1);"><a><span aria-hidden="true">←</span> Previous</a></li>
                                <li class="active" id="first">
                                    <a aria-controls="tab1" data-toggle="tab" href="#tab1" role="tab">1</a>
                                </li>

                                <li class="next" onclick="goTo(2);"><a>Next <span aria-hidden="true">→</span></a></li>
                            </ul>
                        </nav>
                    </div>
                    <div class="tab-content">
                    </div>
                </DIV>
                <div class="modal fade" id="modalGallery" tabindex="-1" role="dialog" aria-labelledby="modalGalleryLabel" aria-hidden="true">
                     <div class="modal-dialog">
                        <div class="modal-content">
                            <div class="modal-header">
                                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">×</button>
                                    <h4 class="modal-title" id="modalGalleryLabel">Gallery</h4>
                            </div> <!-- /.modal-header -->
                            <div class="modal-body">
                                <div id="carouselGallery" class="carousel slide" data-ride="carousel" data-interval="false">
                                     <div class="carousel-inner"> </div> <!-- /.carousel-inner -->
                                </div> <!-- /.carousel -->
                            </div> <!-- /.modal-body -->
                            <div class="modal-footer">
                                 <ul class="pagination"> </ul>
                            </div> <!-- /.modal-footer -->
                        </div> <!-- /.modal-content -->
                    </div> <!-- /.modal-dialog -->
                </div> <!-- /.modal -->

            </SECTION>
        </DIV>
        
        <FOOTER>
            Powered by <A href="http://scipion.cnb.csic.es">Scipion</A><img class="icon" src="https://cdn.rawgit.com/I2PC/scipion/master/pyworkflow/resources/favicon.png">
        </FOOTER>
    </BODY>
    <SCRIPT>
    
        var report ={
            date:"%(dateStr)s",
            project:"%(projectName)s",
            scipionVersion:"%(scipionVersion)s",
            acquisition:[
                %(acquisitionLines)s    
            ],
            runs:[
                %(runLines)s
            ],
            ctfData: %(ctfData)s,
            systemData: %(systemData)s
        }

        String.prototype.format = function() {
            var formatted = this;
            for (var i = 0; i < arguments.length; i++) {
                var regexp = new RegExp('\\{'+i+'\\}', 'gi');
                formatted = formatted.replace(regexp, arguments[i]);
            }
            return formatted;
        };

        function goTo(number){
           $('ul.pager li:eq('+number+') a').tab('show');
           upgradePreNext(number);
        }

        function upgradePreNext(number){
           if (number>1){
               $('ul.pager li:eq(0)').attr("onclick","goTo("+(number-1)+")");
               $('ul.pager li:eq(0)').attr("class", "previous");
           } else {
               $('ul.pager li:eq(0)').attr("class", "disabled");
           }
            if (number<5){
               $('ul.pager li:eq(6)').attr("onclick","goTo("+(number+1)+")");
               $('ul.pager li:eq(6)').attr("class", "next");
           } else {
               $('ul.pager li:eq(6)').attr("class", "disabled");
           }
        }

        function addAcquisition(){
            // Get the acquisition section
            var acquisitionSection = $('#acquisition');
            
            // For each acquisition property
            $.each(report.acquisition, function(index, value){
                var line = "<P class='propertyline'><label>" + value.propertyName + "</label> " + value.propertyValue + '</P>';
                $(acquisitionSection).append(line);
            });
            
        };
        
        function addRuns(){
            // Get the runs table
            var runsTable = $('#runsTable');


            // For each protocol property
            $.each(report.runs, function(index, value){
                var line = "<TR class='protocolLine'><TD>" + value.protocolName + "</TD><TD colspan='2'></TD></TR>";
                $(runsTable).append(line);
            
                $.each(value.output, function(index, value){
                    var outputLine = "<TR><TD></TD><TD>" + value.name + "</TD><TD class='center'>" + value.size + "</TD></TR>";
                    $(runsTable).append(outputLine);
                
                });
            });
        };

        function createGallery(galleryId, currentSlideIndex){
            var galleryBox = $(galleryId + ' .carousel-inner');
            $('a[data-target="'+ galleryId +'"]').each(function(){
                var img = $(this).html();
                var galleryItem = $('<div class="item">'+ img +'</div>');
                galleryItem.appendTo(galleryBox); });
                galleryBox.children('.item').eq(currentSlideIndex).addClass('active');
                setTitle(galleryId, currentSlideIndex);

        }

        function destroyGallry(galleryId){
            $(galleryId + ' .carousel-inner').html("");

        }

        function createPagination(galleryId, currentSlideIndex){
            var pagination = $(galleryId + ' .pagination');
            var carouselId = $(galleryId).find('.carousel').attr('id');
            var prevLink = $('<li><a href="#'+ carouselId +'" data-slide="prev">«</a></li>');
            var nextLink = $('<li><a href="#'+ carouselId +'" data-slide="next">»</a></li>');
            prevLink.appendTo(pagination); nextLink.appendTo(pagination);
            $('a[data-target="'+ galleryId +'"]').each(function(){
                var linkIndex = $(this).index('a[data-target="'+ galleryId +'"]');
                var paginationLink = $('<li><a data-target="#carouselGallery" data-slide-to="'+ linkIndex +'">'+ (linkIndex+1) +'</a></li>');
                paginationLink.insertBefore('.pagination li:last-child'); });
                setPagination(++currentSlideIndex);

        }

        function setPagination(currentSlideIndex, reset = false){
            if (reset){
                $('.pagination li').removeClass('active');
            }
            $('.pagination li').eq(currentSlideIndex).addClass('active');
        }

        function destroyPagination(galleryId){
            $(galleryId + ' .pagination').html("");

        }

        function setTitle(galleryId, currentSlideIndex){
            var imgAlt = $(galleryId + ' .item').eq(currentSlideIndex).find('img').attr('alt');
            $('.modal-title').text(imgAlt);
        }

        function addMicGallery(){
            // Add pager
            var pager = $('.pager #first');
            var gridSize = 9; // our grid will be 3x3
            var numMics = report.ctfData.imgMicThumbs.length;
            var numPages = Math.ceil(numMics / gridSize);
            var imgIndex = 0;

            for (i=1; i<=numPages; i++) {
                if(i ==1){
                    $('.tab-content').append('<div class="tab-pane active" id="tab1" role="tabpanel"></div>');
                }else{
                    pager.after('<li> <a aria-controls="tab{0}" \
                                 data-toggle="tab" href="#tab{0}" role="tab">{0}</a></li>'.format(i));
                    $('.tab-content').append('<div class="tab-pane" id="tab{0}" role="tabpanel"></div>'.format(i));
                };
                for(j=1; j<=gridSize; j++){
                    imgIndex = gridSize*(i-1)+(j-1);
                    var imgThumbPath = report.ctfData.imgMicThumbs[imgIndex];
                    var imgPath = report.ctfData.imgMicPath[imgIndex];
                    var imgDescription = imgPath.split("/").pop()
                    
                    $('.tab-pane#tab{0}'.format(i)).append('<div class="col-sm-3"> \
                                                                <div class="thumbnail"> \
                                                                    <a href="#galleryImg{0}" class="link-gallery" data-toggle="modal" data-target="#modalGallery"> \
                                                                        <img class="img-responsive img-gallery" alt={3} src={2}> \
                                                                    </a> \
                                                                    <div class="caption"> \
                                                                        <h3>Micrograph {1}</h3>\
                                                                    </div> \
                                                                <\div>\
                                                            </div>'.format(imgIndex, imgIndex+1, imgThumbPath, imgDescription));
                    if (imgIndex+1 === numMics) {
                        break;
                    };
                };
            };


        };

//        function addMicTable(){
//            var dataset = [];
//            $.each(report.ctfData.imgMicThumbs, function(index, value) {
//                var rowValues = ["<img src="+ value +">", value];
//                dataset.push(rowValues)
//            });
//
//            $('#micTable').DataTable( {
//                data: dataset,
//                columns: [
//                    {title: "Mic"},
//                    {title: "Mic Path"}
//                ]
//            });
//
//        };

//        function addMicThumbs(){
//            var imgTabCount = 0;
//            var micThumbDiv = $('#micThumbs');
//            var nTabs = 0;
//            var firstTab = '<div class="tab-pane" id="tab1" role="tabpanel">' +
//                           '</div>'
//
//
//        };

        function addCTFChart () {
            
            $('#ctfChart').highcharts({
                title: {
                    text: '',
                    x: -20 //center
                },
                subtitle: {
                    text: 'Click and drag to zoom in. Hold down shift key to pan.'
                },
                xAxis: {
                    title: {
                        text: 'Micrograph index'
                    },
                    allowDecimals: false,
                    type:'linear',
                    range:50
                },
                yAxis: {
                    title: {
                        text: 'Defocus(A)'
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#D14242'
                    }]
                },
                tooltip: {
                    valueSuffix: ' A'
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                    borderWidth: 0
                },
                series: [{
                    name: 'Defocus U',
                    data: report.ctfData.defocusU,
                    color: '#24307B'
                    
                }, {
                    name: 'Defocus V',
                    data: report.ctfData.defocusV,
                    color: '#B4AC22'
                }],
                chart:{
                    zoomType: 'x',
                    panning: true,
                    panKey:'shift'    
                }                
            });
            
            // Since we are using a range of 50 in the Xaxis and the zoom button does not shows up
            // we force it
            var ctfChart = $('#ctfChart').highcharts()
            ctfChart.showResetZoom();


            
        };

        function addSystemChart () {
            
            $('#systemChart').highcharts({
                title: {
                    text: '',
                    x: -20 //center
                },
                subtitle: {
                    text: 'Click and drag to zoom in. Hold down shift key to pan.'
                },
                xAxis: {
                    title: {
                        text: 'Time (hours)'
                    },

                    type:'linear',
                    labels:{
                        format:"{value:.2f}"
                    },
                    range:50
                },
                yAxis: {
                    title: {
                        text: 'Percentage (%%)'
                    },
                    plotLines: [{
                        value: 0,
                        width: 1,
                        color: '#D14242'
                    }]
                },
                tooltip: {
                    valueSuffix: '%%'
                },
                legend: {
                    layout: 'vertical',
                    align: 'right',
                    verticalAlign: 'middle',
                    borderWidth: 0
                },
                series: [{
                    name: 'Memory',
                    data: report.systemData.mem,
                    color: '#24307B'
                    
                }, {
                    name: 'Swap',
                    data: report.systemData.swap,
                    color: '#B4AC22'
                }, {
                    name: 'cpu',
                    data: report.systemData.cpu,
                    color: '#D14242'
                }],
                chart:{
                    zoomType: 'x',
                    panning: true,
                    panKey:'shift'
                } 
            });

            // Since we are using a range of 50 in the Xaxis and the zoom button does not shows up
            // we force it
            var systemChart = $('#systemChart').highcharts()
            systemChart.showResetZoom();
            
            
        };

        function populateReport(){
            addAcquisition();
            addRuns();
            addCTFChart();
            addSystemChart();
            addMicGallery();
        };
        
        populateReport();

        $(document).ready(function(){
            // gallery pagination things
            $('li a').on('click',function(e){
                goTo((e.target.innerHTML)-0);
            });
            $('.link-gallery').click(function(){
                var galleryId = $(this).attr('data-target');
                var currentLinkIndex = $(this).index('a[data-target="'+ galleryId +'"]');
                createGallery(galleryId, currentLinkIndex); createPagination(galleryId, currentLinkIndex);
                $(galleryId).on('hidden.bs.modal', function (){
                    destroyGallry(galleryId);
                    destroyPagination(galleryId);
                });
                $(galleryId +' .carousel').on('slid.bs.carousel', function (){
                    var currentSlide = $(galleryId +' .carousel .item.active');
                    var currentSlideIndex = currentSlide.index(galleryId +' .carousel .item');
                    setTitle(galleryId, currentSlideIndex);
                    setPagination(++currentSlideIndex, true);
                })

            });
        });
        
        
    </SCRIPT>
<HTML>